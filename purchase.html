<script>
// ===== Product info from URL =====
const urlParams = new URLSearchParams(window.location.search);
const productName = urlParams.get("name") || "Unknown Product";
const productPrice = urlParams.get("price") || "$0.00";
document.getElementById("itemName").textContent = productName;
document.getElementById("itemPrice").textContent = productPrice;

// ===== CashApp =====
document.getElementById("cashappBtn").addEventListener("click",()=>{
    window.location.href = "https://cash.app/$durgot";
});

// ===== TalkJS Chat =====
const talkjsAppId = "tRkW5nYP";
const username = localStorage.getItem("username");
const userEmail = localStorage.getItem("userEmail");
const userId = localStorage.getItem("userId");

let chatBoxInstance = null;
let chatOpen = false;

document.getElementById("chatBtn").addEventListener("click", async ()=>{
    if(!username){
        window.location.href = "signup.html";
        return;
    }

    await Talk.ready;

    const me = new Talk.User({
        id: userId,
        name: username,
        email: userEmail,
        photoUrl:`https://ui-avatars.com/api/?name=${username.charAt(0)}&background=00ff9c&color=000`
    });

    const seller = new Talk.User({
        id:"seller",
        name:"ElDorado Seller",
        email:"seller@example.com",
        photoUrl:"https://i.imgur.com/0F9Z4.png"
    });

    const session = new Talk.Session({
        appId: talkjsAppId,
        me: me,
        notify:false
    });

    const conversation = session.getOrCreateConversation(Talk.oneOnOneId(me,seller));
    conversation.setParticipant(me);
    conversation.setParticipant(seller);

    const chatContainer = document.getElementById("chatContainer");

    // Toggle chat open/close
    if(!chatOpen){
        chatBoxInstance = session.createChatbox(conversation);
        chatBoxInstance.mount(chatContainer);
        chatContainer.style.display = "block"; // show chat container
        document.getElementById("chatBtn").textContent = "Close Chat with Seller";
        chatOpen = true;
    } else {
        chatBoxInstance.destroy(); // remove chat from DOM
        chatContainer.style.display = "none"; // hide chat container
        document.getElementById("chatBtn").textContent = "Open Chat with Seller";
        chatOpen = false;
    }
});

// Initially hide chat container
document.getElementById("chatContainer").style.display = "none";
</script>

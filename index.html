<<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MarketX</title>
<script src="https://cdn.talkjs.com/talk.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
header{height:60px;background:#141a38;display:flex;align-items:center;padding:0 20px;font-weight:bold;font-size:20px;}
header span{color:#00f5a0;margin-left:5px;}
.main{display:flex;height:calc(100vh - 60px);}
.sidebar{width:320px;background:#12172a;padding:20px;overflow-y:auto;}
.shop-card{background:#1a2040;padding:20px;margin-bottom:15px;border-radius:12px;border:1px solid #2a3380;}
.shop-card h3{margin:0 0 5px 0;}
.shop-card .price{color:#00f5a0;font-weight:bold;margin-bottom:8px;}
.shop-card button{width:100%;padding:10px;border-radius:8px;border:none;background:#00f5a0;color:#000;font-weight:bold;cursor:pointer;}
.chat-panel{flex:1;background:#141c2a;padding:20px;display:flex;flex-direction:column;}
#chat{flex:1;border-radius:12px;overflow:hidden;border:1px solid #2a3380;background:#0c1024;margin-top:10px;}
.hidden{display:none;}
.center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
.login-box{width:320px;padding:30px;background:#141a38;border-radius:14px;display:flex;flex-direction:column;}
input,button{margin-top:10px;padding:12px;border-radius:6px;border:none;font-size:14px;}
button{cursor:pointer;font-weight:bold;background:#00f5a0;color:#000;}
button.logout{background:#333;color:#fff;}
</style>
</head>
<body>

<header>Market<span>X</span></header>

<!-- LOGIN -->
<div id="loginPage" class="center">
  <div class="login-box">
    <h2>Login / Register</h2>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Login / Register</button>
    <small style="color:#888;margin-top:10px;">Seller: Kirby / Kirby</small>
  </div>
</div>

<!-- SHOP + CHAT -->
<div id="shopPage" class="hidden main">
  <div class="sidebar" id="shopContent">
    <h3>Shop Products</h3>
    <!-- Products injected here -->
  </div>
  <div class="chat-panel">
    <h3 id="welcomeText"></h3>
    <div id="chat"></div>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</div>

<script>
const SELLER={username:"Kirby",password:"Kirby",role:"seller"};
let currentUser=null;
let session=null;

const products=[
  {name:"Game Currency",price:5.99},
  {name:"Starter Account",price:14.99},
  {name:"Premium Account",price:29.99}
];

function login(){
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value.trim();
  if(!u||!p){alert("Enter username and password");return;}

  if(u==="Kirby" && p==="Kirby") currentUser=SELLER;
  else currentUser={username:u,password:p,role:"buyer"};

  localStorage.setItem("user",JSON.stringify(currentUser));
  showShop();
}

function showShop(){
  currentUser=JSON.parse(localStorage.getItem("user"));
  if(!currentUser) return;

  // Hide login, show shop
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("shopPage").classList.remove("hidden");
  document.getElementById("welcomeText").innerText="Welcome, "+currentUser.username;

  const shopContainer=document.getElementById("shopContent");
  shopContainer.innerHTML="<h3>Shop Products</h3>";

  if(currentUser.role==="buyer"){
    products.forEach(p=>{
      const div=document.createElement("div");
      div.className="shop-card";
      div.innerHTML=`<h3>${p.name}</h3>
        <div class="price">$${p.price.toFixed(2)}</div>
        <button onclick="openChat()">Open Chat</button>`;
      shopContainer.appendChild(div);
    });
  } else {
    shopContainer.innerHTML="<h3>Seller Inbox</h3>";
  }

  // Initialize TalkJS session
  Talk.ready.then(()=>{
    session=new Talk.Session({
      appId:"tUlq8yXw", // YOUR APP KEY
      me:new Talk.User({
        id:currentUser.role+"_"+currentUser.username,
        name:currentUser.username
      })
    });

    if(currentUser.role==="seller"){
      // Seller sees inbox
      const inbox=session.createInbox();
      inbox.mount(document.getElementById("chat"));
    }
  }).catch(e=>{
    console.error("TalkJS failed:",e);
    alert("TalkJS failed to load. Must run on localhost or live server.");
  });
}

// Buyers open 1-on-1 chat with seller
function openChat(){
  if(currentUser.role==="seller") return;
  const buyer=new Talk.User({id:"buyer_"+currentUser.username,name:currentUser.username});
  const seller=new Talk.User({id:"seller_Kirby",name:"Kirby"});
  const convo=session.getOrCreateConversation(Talk.oneOnOneId(buyer,seller));
  convo.setParticipant(buyer);
  convo.setParticipant(seller);
  const chatbox=session.createChatbox(convo,{showChatHeader:true});
  chatbox.mount(document.getElementById("chat"));
}

function logout(){
  localStorage.removeItem("user");
  location.reload();
}

// Auto-show shop if already logged in
if(localStorage.getItem("user")) showShop();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MarketX</title>
<script src="https://cdn.talkjs.com/talk.js"></script>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
header {height:60px;background:#141a38;display:flex;align-items:center;padding:0 20px;font-weight:bold;font-size:20px;}
header span {color:#00f5a0;margin-left:5px;}
.main {display:flex;height:calc(100vh - 60px);}
.sidebar {width:400px;background:#12172a;padding:20px;overflow-y:auto;}
.grid {display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.shop-card {background:#1a2040;padding:15px;border-radius:10px;border:1px solid #2a3380;text-align:center;}
.shop-card h3 {margin:10px 0;}
.shop-card .price {color:#00f5a0;font-weight:bold;margin-bottom:10px;}
.shop-card button {padding:8px 0;border:none;border-radius:6px;background:#00f5a0;color:#000;font-weight:bold;cursor:pointer;width:100%;}
.chat-panel {flex:1;background:#141c2a;padding:20px;display:flex;flex-direction:column;}
#chat {flex:1;border-radius:12px;overflow:hidden;border:1px solid #2a3380;background:#0c1024;margin-top:10px;}
.hidden {display:none;}
.login-container {padding:30px;max-width:320px;margin:50px auto;background:#141a38;border-radius:14px;}
input,button {margin-top:10px;padding:12px;border-radius:6px;border:none;font-size:14px;}
button {cursor:pointer;font-weight:bold;background:#00f5a0;color:#000;}
button.logout {background:#333;color:#fff;margin-top:10px;}
</style>
</head>
<body>

<header>Market<span>X</span></header>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <h2>Login / Register</h2>
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login / Register</button>
  <small style="color:#888;margin-top:10px;">Seller: Kirby / Kirby</small>
</div>

<!-- SHOP + CHAT -->
<div id="shopPage" class="main hidden">
  <div class="sidebar">
    <h3>Shop</h3>
    <div id="shopContent" class="grid"></div>
  </div>
  <div class="chat-panel">
    <h3 id="welcomeText"></h3>
    <div id="chat"></div>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</div>

<script>
const SELLER = {username:"Kirby", password:"Kirby", role:"seller"};
let currentUser = null;
let session = null;

const products = [
  {name:"Game Currency", price:5.99},
  {name:"Starter Account", price:14.99},
  {name:"Premium Account", price:29.99},
  {name:"Rare Skin", price:9.99},
  {name:"VIP Pass", price:19.99},
  {name:"Legend Account", price:49.99}
];

function login() {
  const u = document.getElementById('user').value.trim();
  const p = document.getElementById('pass').value.trim();
  if(!u || !p){ alert("Enter username and password"); return; }

  if(u === "Kirby" && p === "Kirby") currentUser = SELLER;
  else currentUser = {username:u, password:p, role:"buyer"};

  localStorage.setItem("user", JSON.stringify(currentUser));
  showShop();
}

function showShop() {
  currentUser = JSON.parse(localStorage.getItem("user"));
  if(!currentUser) return;

  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("shopPage").classList.remove("hidden");
  document.getElementById("welcomeText").innerText = "Welcome, " + currentUser.username;

  const shopContainer = document.getElementById("shopContent");
  shopContainer.innerHTML = "";

  if(currentUser.role === "buyer") {
    products.forEach(p=>{
      const div = document.createElement("div");
      div.className = "shop-card";
      div.innerHTML = `<h3>${p.name}</h3>
        <div class="price">$${p.price.toFixed(2)}</div>
        <button onclick="openChat('${p.name}')">Open Chat</button>`;
      shopContainer.appendChild(div);
    });
  } else {
    shopContainer.innerHTML = "<h3>Seller Inbox</h3><p>All buyers' messages appear on the right.</p>";
  }

  // Initialize TalkJS
  Talk.ready.then(()=>{
    session = new Talk.Session({
      appId:"tUlq8yXw",
      me: new Talk.User({
        id: currentUser.role + "_" + currentUser.username,
        name: currentUser.username
      })
    });

    if(currentUser.role === "seller"){
      const inbox = session.createInbox();
      inbox.mount(document.getElementById("chat"));
    }
  }).catch(e=>{
    console.error("TalkJS failed:", e);
    alert("TalkJS failed to load. Must run on a server, not file:///");
  });
}

function openChat(itemName) {
  if(currentUser.role === "seller") return;
  const buyer = new Talk.User({id:"buyer_" + currentUser.username, name:currentUser.username});
  const seller = new Talk.User({id:"seller_Kirby", name:"Kirby"});
  const convo = session.getOrCreateConversation(Talk.oneOnOneId(buyer,seller));
  convo.setParticipant(buyer);
  convo.setParticipant(seller);

  const chatbox = session.createChatbox(convo,{showChatHeader:true});
  chatbox.mount(document.getElementById("chat"));
}

function logout() {
  localStorage.removeItem("user");
  location.reload();
}

// Auto show shop if user is already logged in
if(localStorage.getItem("user")) showShop();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MarketX</title>
<script src="https://cdn.talkjs.com/talk.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center;}
.box{background:#141a38;padding:30px;border-radius:14px;width:320px;max-width:90%;}
input,button{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:none;font-size:14px;}
button{background:#00f5a0;font-weight:800;cursor:pointer;}
button.logout{background:#333;}
.hidden{display:none;}
#chat{height:420px;border-radius:14px;overflow:hidden;margin-top:12px;}
h2{margin:0 0 10px 0;text-align:center;}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="center" id="loginPage">
  <div class="box">
    <h2>Login / Register</h2>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Login / Register</button>
    <p style="font-size:12px;margin-top:10px">New buyer? Just enter a username & password.</p>
  </div>
</div>

<!-- SHOP PAGE -->
<div class="center hidden" id="shopPage">
  <div class="box">
    <h2>Welcome, <span id="who"></span></h2>
    <div id="shopContent" class="hidden">
      <div class="card">
        <h3>Game Currency</h3>
        <div class="desc">Fast delivery • Trusted seller</div>
        <div class="price">$5.99</div>
        <button onclick="openChat()">Open Chat</button>
      </div>
      <div class="card">
        <h3>Starter Account</h3>
        <div class="desc">Verified • Secure</div>
        <div class="price">$14.99</div>
        <button onclick="openChat()">Open Chat</button>
      </div>
      <div class="card">
        <h3>Premium Account</h3>
        <div class="desc">Full access • Clean</div>
        <div class="price">$29.99</div>
        <button onclick="openChat()">Open Chat</button>
      </div>
    </div>
    <div id="chat"></div>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</div>

<script>
const SELLER = { username:"Kirby", password:"Kirby", role:"seller" };
let currentUser = null;
let session = null;

function login(){
  const u = document.getElementById('user').value.trim();
  const p = document.getElementById('pass').value.trim();
  if(!u || !p){ alert("Enter username and password."); return; }

  if(u==="Kirby" && p==="Kirby"){
    currentUser = SELLER;
  } else {
    currentUser = { username:u, password:p, role:"buyer" };
    // store buyers locally
    let buyers = JSON.parse(localStorage.getItem("buyers")||"[]");
    if(!buyers.find(b=>b.username===u)) buyers.push(currentUser);
    localStorage.setItem("buyers",JSON.stringify(buyers));
  }
  localStorage.setItem("user", JSON.stringify(currentUser));
  startShop();
}

function startShop(){
  currentUser = JSON.parse(localStorage.getItem("user"));
  if(!currentUser) return;

  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('shopPage').classList.remove('hidden');
  document.getElementById('who').innerText = currentUser.username;

  // Show shop only for buyers
  if(currentUser.role==="buyer"){
    document.getElementById('shopContent').classList.remove('hidden');
  }

  // init TalkJS session
  Talk.ready.then(()=>{
    session = new Talk.Session({
      appId:"tUlq8yXw",
      me:new Talk.User({
        id: currentUser.role+"_"+currentUser.username,
        name: currentUser.username
      })
    });

    // Seller sees all buyer inboxes
    if(currentUser.role==="seller"){
      const inbox = session.createInbox();
      inbox.mount(document.getElementById('chat'));
    }
  });
}

function openChat(){
  if(currentUser.role==="seller") return;

  const seller = new Talk.User({ id:"seller_Kirby", name:"Kirby" });
  const buyer = new Talk.User({ id:"buyer_"+currentUser.username, name:currentUser.username });

  const convo = session.getOrCreateConversation(Talk.oneOnOneId(buyer, seller));
  convo.setParticipant(buyer);
  convo.setParticipant(seller);

  const chatbox = session.createChatbox(convo,{showChatHeader:false});
  chatbox.mount(document.getElementById('chat'));
}

function logout(){
  localStorage.removeItem("user");
  location.reload();
}

startShop();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ElDorado Marketplace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.talkjs.com/talk.js"></script>
<style>
body {
    margin:0;
    font-family:'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#0f1115,#1a1c25);
    color:#fff;
    min-height:100vh;
    padding:30px;
}
h1{color:#00ff9c;text-align:center;margin-bottom:40px;}
.product-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
    gap:20px;
}
.product-card{
    background:#1c1e2a;
    border-radius:20px;
    padding:20px;
    text-align:center;
    box-shadow:0 0 20px #00ff9c;
}
.product-card h2{margin:10px 0;color:#00ff9c;}
.product-card p{margin:5px 0;color:#fff;}
.product-card button{
    padding:10px 15px;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
    margin-top:10px;
}
.buyBtn{background:#00c244;color:#fff;}
.chatBtn{background:#00aaff;color:#fff;}
.buyBtn:hover,.chatBtn:hover{opacity:0.85;}
</style>
</head>
<body>
<h1>ElDorado Marketplace</h1>
<div class="product-grid" id="productGrid">
  <!-- Products added by JS -->
</div>

<script>
// ===== User Login Check =====
const username = localStorage.getItem("username");
const userEmail = localStorage.getItem("userEmail");

// ===== Sample Products =====
const products = [
  {name:"Eldorado Gem #1", price:"$10.00"},
  {name:"Eldorado Gem #2", price:"$15.00"},
  {name:"Eldorado Gem #3", price:"$20.00"},
];

const grid = document.getElementById("productGrid");

products.forEach(prod=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML = `
        <h2>${prod.name}</h2>
        <p>Price: ${prod.price}</p>
        <button class="buyBtn">Buy</button>
        <button class="chatBtn">Chat with Seller</button>
    `;
    grid.appendChild(card);

    const buyBtn = card.querySelector(".buyBtn");
    const chatBtn = card.querySelector(".chatBtn");

    // Buy button
    buyBtn.addEventListener("click", ()=>{
        if(!username){
            window.location.href="signup.html";
        } else {
            const url = `purchase.html?name=${encodeURIComponent(prod.name)}&price=${encodeURIComponent(prod.price)}`;
            window.location.href=url;
        }
    });

    // Chat button
    chatBtn.addEventListener("click", async ()=>{
        if(!username){
            window.location.href="login.html";
            return;
        }

        await Talk.ready;

        const buyer = new Talk.User({
            id: "buyer_" + username,
            name: username,
            email: userEmail || "guest@example.com",
            photoUrl: "https://i.imgur.com/0F9Z4.png"
        });

        const seller = new Talk.User({
            id: "seller", // Must match admin
            name: "ElDorado Seller",
            email: "seller@example.com",
            photoUrl: "https://i.imgur.com/0F9Z4.png"
        });

        const session = new Talk.Session({appId:"tRkW5nYP", me: buyer, notify:false});
        const conversation = session.getOrCreateConversation(Talk.oneOnOneId(buyer, seller));
        conversation.setParticipant(buyer);
        conversation.setParticipant(seller);

        // Open chat in popup
        const chatbox = session.createChatbox(conversation);
        chatbox.mount(document.createElement("div"));
        chatbox.show();
    });
});
</script>
</body>
</html>
